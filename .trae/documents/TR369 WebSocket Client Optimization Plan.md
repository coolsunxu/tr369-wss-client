# TR369 WebSocket 客户端优化计划

## 高优先级问题

### 1.  bug 修复
- **URL 查询参数处理**：修复 `client.go:74` 中的 URL 构建逻辑，确保正确处理已存在的查询参数
- **空指针安全**：在 `Disconnect` 方法中添加 WebSocket 连接的空指针检查
- **缺失函数定义**：实现或移除仓库中的 `loadDefaultTR181Nodes` 函数
- **错误处理**：修复 `HandleMTPMsgTransmit` 方法中被忽略的错误

### 2.  日志记录不一致
- **统一日志框架**：将所有 `slog` 用法替换为现有 `logger` 包
- **改进日志级别**：确保一致使用适当的日志级别（Info、Warn、Error）

### 3.  移除冗余代码
- **移除包装函数**：删除 `client.go:19-21` 中冗余的 `contains` 函数
- **移除测试代码**：移除 `usecase/client.go:78-83` 中的测试代码
- **移除冗余字段**：从 `ClientUseCase` 结构体中移除重复字段

### 4.  安全性改进
- **替换不安全指针**：重写 `RandStr` 函数，避免使用 `unsafe.Pointer`

## 中优先级问题

### 5.  性能优化
- **改进磁盘 I/O**：优化 `DataSynchronizationTick` 函数，使用更智能的批处理方式
- **配置重试逻辑**：使 `LoadJsonFile` 函数中的重试参数可配置
- **优化通道使用**：添加适当的通道关闭和大小验证

### 6.  内存使用优化
- **避免重复数据**：从用例层移除重复的 `TR181DataModel`
- **正确使用上下文**：确保所有 goroutine 中上下文取消的一致性

### 7.  改进错误处理
- **一致的错误传播**：确保错误被正确返回和处理
- **添加错误类型**：定义自定义错误类型以更好地分类错误

## 低优先级问题

### 8.  代码结构改进
- **移除接口嵌入**：从结构体中移除不必要的接口嵌入
- **改进依赖注入**：确保整个代码库中正确的依赖注入

### 9.  最佳实践实现
- **添加配置验证**：在启动时验证配置
- **实现重连机制**：添加 WebSocket 重连逻辑
- **添加指标**：实现基本的指标收集用于监控

## 实施步骤

1. **修复关键 bug**（URL 处理、空指针、缺失函数、忽略的错误）
2. **统一日志记录** 整个代码库
3. **移除冗余代码** 和不安全操作
4. **优化性能** 和内存使用
5. **改进错误处理** 和代码结构
6. **实现最佳实践** 以提高健壮性和可维护性

每个优化都将以对现有代码库结构的最小更改来实现，在保持清晰架构的同时提高性能、可靠性和可维护性。